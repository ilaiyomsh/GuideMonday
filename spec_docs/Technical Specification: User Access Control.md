# מפרט טכני: בקרת גישת משתמשים למדריך אינטראקטיבי

| גרסה | תאריך | מחבר |
|-------|--------|-------|
| 1.0 | 26 בספטמבר 2025 | אדריכל תוכנה |

## 1. סקירה כללית

מסמך זה מפרט את העיצוב הטכני ליישום מערכת בקרת גישה מבוססת תפקידים (RBAC) עבור אפליקציית המדריך האינטראקטיבי. המטרה היא לבצע הבחנה בין בעלי לוח לתפקידים אחרים (למשל, חברי לוח). הגישה לפונקציונליות העריכה של המדריך תוגבל אך ורק לבעלי הלוח.

## 2. דרישות

### 2.1 דרישות פונקציונליות

**תצוגה ברירת מחדל**: כברירת מחדל, כל המשתמשים יצפו במדריך במצב קריאה בלבד עם טעינת האפליקציה.

**בקרת גישה לעריכה**: פקד הממשק לכניסה ל"מצב עריכה" (למשל, כפתור "ערוך מדריך") יוצג אם ורק אם המשתמש הנוכחי הוא בעל מוגדר של הלוח.

**זיהוי תפקיד דינמי**: תפקיד המשתמש חייב להיקבע באופן דינמי בכל טעינה של מופע האפליקציה כדי להבטיח שההרשאות תמיד מעודכנות.

## 3. אדריכלות המערכת ועיצוב

### 3.1 טכנולוגיה ליבה

כל האינטראקציות עם פלטפורמת Monday.com, כולל אחזור נתוני הפעלה של המשתמש והקשר הלוח, יטופלו באופן בלעדי באמצעות ספריית monday-sdk-js.

### 3.2 זרימת הרשאה

תהליך ההרשאה יבוצע באתחול האפליקציה. הזרימה היא כדלקמן:

1. **אחזור מזהה המשתמש הנוכחי (userId)**: אחזור נתוני הפעלה של המשתמש הפעיל באמצעות `monday.get('session')`.

2. **אחזור מזהה הלוח הנוכחי (boardId)**: אחזור הקשר האפליקציה באמצעות `monday.get('context')`.

3. **אחזור רשימת בעלי הלוח**: ביצוע שאילתת GraphQL באמצעות `monday.api()` לאחזור רשימת המשתמשים המוגדרים כבעלים עבור הלוח הנוכחי.

4. **השוואה והרשאה**: השוואת ה-userId הנוכחי מול רשימת מזהי הבעלים שנאחזרה. אם נמצאה התאמה, מתן הרשאות עריכה עבור ההפעלה הנוכחית.

**שאילתת GraphQL לאחזור בעלי הלוח:**

```graphql
query($boardIds: [Int!]) {
  boards (ids: $boardIds) {
    owners {
      id
    }
  }
}
```

## 4. יישום ב-React

### 4.1 ניהול מצב

משתנה מצב בוליאני ייעודי יתווסף למכולה הראשית של האפליקציה לניהול רמת ההרשאה של המשתמש.

**isBoardOwner [Boolean]**: מאחסן את תוצאת בדיקת ההרשאה. ברירת מחדל היא false.

### 4.2 לוגיקת הרשאה ב-useEffect

זרימת ההרשאה תשולב ב-hook הראשי useEffect, שרץ עם טעינת הקומפוננטה. מומלץ להשתמש ב-Promise.all להרצת קריאות ה-API של הקשר וההפעלה במקביל לביצועים אופטימליים.

**דוגמת קוד: שילוב בדיקת הרשאה באתחול האפליקציה**

```javascript
useEffect(() => {
  const initializeApp = async () => {
    try {
      setLoading(true);

      // אחזור נתוני הקשר והפעלה במקביל
      const [contextRes, sessionRes] = await Promise.all([
        monday.get('context'),
        monday.get('session')
      ]);

      const boardId = contextRes.data.boardId;
      const currentUserId = sessionRes.data.userId;

      // אחזור רשימת בעלי הלוח באמצעות GraphQL
      const query = `query($boardIds: [Int!]) { boards (ids: $boardIds) { owners { id } } }`;
      const variables = { boardIds: [boardId] };
      const ownersRes = await monday.api(query, { variables });

      const owners = ownersRes.data.boards[0].owners;

      // בדיקה אם המשתמש הנוכחי נמצא ברשימת הבעלים
      const isOwner = owners.some(owner => Number(owner.id) === currentUserId);
      setIsBoardOwner(isOwner); // הגדרת מצב ההרשאה

      // ...המשך עם לוגיקת טעינת נתוני המדריך...

    } catch (error) {
      console.error("Failed to initialize app and permissions:", error);
      setIsBoardOwner(false); // ברירת מחדל ללא-בעלים בשגיאה
    } finally {
      setLoading(false);
    }
  };

  initializeApp();
}, []);
```

### 4.3 עיבוד מותנה

כפתור "ערוך מדריך" יעובד באופן מותנה בהתבסס על מצב isBoardOwner. השיטה הסטנדרטית והקצרה ביותר לכך ב-React היא שימוש באופרטור הלוגי && בתוך ה-JSX.

**דוגמת קוד: עיבוד מותנה של כפתור העריכה**

```javascript
// בקומפוננטת התצוגה הראשית

<div>
  {/* ...התוכן לקריאה בלבד של המדריך מעובד כאן... */}

  {/* בלוק זה יעובד ל-DOM רק אם isBoardOwner הוא true.
    זוהי נקודת הכניסה להפעלת מצב עריכה.
  */}
  {isBoardOwner && (
    <button onClick={() => setEditMode(true)}>
      ערוך מדריך
    </button>
  )}
</div>
```

## 5. טיפול בשגיאות

במקרה של כשל API במהלך תהליך ההרשאה (למשל, שגיאת רשת באחזור בעלים), האפליקציה תחזור למצב הבטוח ביותר על ידי הגדרת isBoardOwner ל-false. זה מבטיח שמשתמשים לא יקבלו בטעות הרשאות מוגברות.